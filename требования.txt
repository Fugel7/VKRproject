1. Общие сведения
1.1. Назначение

Система — таск-трекер, интегрированный в Telegram в формате Mini App, предназначен для систематизации взаимодействия заказчика и исполнителя (или небольшой команды) в рамках проектов, где основная коммуникация ведётся в Telegram.

1.2. Цели

Устранить потерю задач/договорённостей в чатах.

Повысить прозрачность статусов и сроков.

Сократить время на «организационные операции» за счёт единой структурированной среды.

1.3. Границы (Scope)

Входит в MVP:

Авторизация через Telegram (без отдельной регистрации).

Проект = Telegram-чат (1 чат → 1 проект).

Задачи: создание/редактирование/назначение/статусы.

Комментарии к задаче.

История изменений.

Списки задач + фильтрация/сортировка.

Уведомления исполнителю через бота (минимально: “назначена задача”, “изменён статус/дедлайн”).

Не входит в MVP (можно заложить задел):

Тайм-трекер, финансы/счета/акты.

Глубокая дифф-история полей (построчное сравнение).

Гранулярные права уровня enterprise.

Полноценное файловое хранилище (можно начать с Telegram file_id + метаданные).

2. Термины и сущности
2.1. Основные сущности

Пользователь (User) — Telegram-пользователь.

Проект (Project) — привязка к Telegram-чату/группе/диалогу.

Участник проекта (ProjectMember) — связь user ↔ project + роль.

Задача (Task) — единица работы в проекте.

Комментарий (Comment) — обсуждение/прогресс, привязанный к задаче.

Вложение (Attachment) — файл/ссылка, прикреплённые к задаче или комментарию.

Журнал изменений (TaskAuditLog) — события изменения задачи.

3. Пользователи, роли и права доступа
3.1. Модель ролей (RBAC)

Роль задаётся в рамках проекта.

Роли проекта

OWNER (Владелец/Заказчик проекта): создаёт задачи, назначает исполнителей, редактирует задачи, управляет участниками/ролями.

EXECUTOR (Исполнитель): видит задачи проекта, меняет статус назначенных задач, комментирует, прикладывает результаты.

MEMBER (Участник) (опционально для команды): может просматривать задачи и комментировать (или только просматривать — настраиваемо).

VIEWER (Наблюдатель) (опционально): только чтение.

Примечание: в исходном описании роль «заказчик/исполнитель» определяется относительно задачи (автор — заказчик, назначенный — исполнитель). Для масштабирования лучше зафиксировать роль на уровне проекта + разрешить автору задачи дополнительные права над своей задачей (см. матрицу).

3.2. Матрица доступа (MVP)
Действие	OWNER	EXECUTOR	MEMBER	VIEWER
Просмотр задач проекта	✅	✅	✅	✅
Создание задачи	✅	❌ (опц.)	❌ (опц.)	❌
Редактирование задачи (название/описание/дедлайн/исполнитель)	✅	❌	❌	❌
Изменение статуса задачи	✅	✅ (только назначенные)	❌	❌
Комментирование	✅	✅	✅ (опц.)	❌
Добавление вложений	✅	✅	✅ (опц.)	❌
Просмотр истории изменений	✅	✅	✅	✅
Управление участниками проекта	✅	❌	❌	❌

Правило владельца задачи (дополнение):

Если пользователь — автор задачи, он может редактировать задачу только если он OWNER или если включён режим “автор может редактировать свои задачи” (feature-flag).

4. Пользовательские сценарии (Use Cases)
4.1. Авторизация

Пользователь открывает Mini App из Telegram.

Frontend получает initData от Telegram WebApp SDK.

Backend валидирует initData (HMAC-SHA256 по токену бота).

Если пользователь новый — создаётся запись User.

Создаётся/обновляется сессия (JWT или server-side session).

4.2. Создание задачи (заказчик)

Открыть проект (чат).

Нажать “Создать задачу”.

Заполнить: название, описание, исполнитель, дедлайн, (опц.) вложения.

Сохранить.

Исполнитель получает уведомление от бота.

4.3. Работа исполнителя

Открыть “Назначенные мне”.

Открыть карточку задачи.

Поставить статус “В работе”.

В процессе — комментарии, вложения.

По завершении — статус “Выполнена”.

4.4. Контроль заказчика

Открыть “Созданные мной” / “Все”.

Фильтр по статусу/дедлайну/исполнителю.

Смотреть историю изменений и комментарии.

При необходимости — изменить дедлайн/описание/исполнителя.

Опционально: “Принять/Закрыть” (если добавим статус “Принята”).

5. Экранная модель (UI/UX) — полный перечень экранов

Формат: Экран → назначение → элементы → действия → валидации/состояния.
Все экраны — SPA внутри Telegram, адаптив под mobile/desktop, поддержка светлой/тёмной темы Telegram.

5.1. Экран 0 — Splash/Загрузка

Назначение: инициализация WebApp, получение сессии.
UI:

Лого/название (минимально)

Индикатор загрузки
Логика:

POST /auth/telegram с initData

при успехе → роут на “Проект/Список задач”

при ошибке → экран ошибки (5.2)

5.2. Экран 0.1 — Ошибка авторизации

UI:

Текст: “Не удалось авторизоваться через Telegram”

Кнопка “Повторить”

(опц.) “Открыть поддержку” (ссылка на чат/бота)
Ошибки:

invalid initData / time skew / token mismatch

backend unavailable

5.3. Экран 1 — Выбор проекта (если есть >1)

Назначение: если пользователь состоит в нескольких чатах-проектах.
UI:

Список проектов: название, тип (личный/группа), роль пользователя

Поиск по названию
Действия:

открыть проект → экран 2
Примечание по Telegram:

Если Mini App открыт из конкретного чата и backend уверенно идентифицирует проект — экран можно пропускать.

5.4. Экран 2 — Список задач (основной)

UI:

Верхняя панель:

Название проекта

Иконка фильтров

(опц.) кнопка “+”

Tabs:

“Все”

“Назначенные мне”

“Созданные мной”

Список карточек задач:

Название

Статус (badge)

Исполнитель

Дедлайн (и просрочка)

Последнее обновление

Пагинация/бесконечный скролл
Действия:

открыть задачу → экран 3

создать задачу (OWNER) → экран 4

применить фильтр → экран 2 (обновление)
Фильтры (минимум MVP):

status: Новая / В работе / Выполнена

исполнитель (для OWNER)

дедлайн: сегодня/7 дней/просрочено/без дедлайна

сортировка: по дедлайну, по обновлению, по созданию

5.5. Экран 3 — Карточка задачи

UI блоки:

Заголовок + статус

Метаданные:

Исполнитель

Автор

Дедлайн

Дата создания

Описание

Вложения (если есть)

История изменений (свернуть/развернуть)

Комментарии (лента)

Поле ввода комментария + attach

Action bar (кнопки по правам)
Действия:

сменить статус (EXECUTOR назначенный / OWNER)

редактировать (OWNER) → экран 4 (в режиме Edit)

добавить комментарий

добавить вложение (к задаче или к комментарию)

открыть историю изменений
Валидации:

комментарий: 1..4000 символов

смена статуса: только допустимые переходы

5.6. Экран 4 — Создание/редактирование задачи (форма)

Поля:

Название* (1..120)

Описание (0..10000)

Исполнитель* (выбор из участников проекта)

Дедлайн (дата/время, опц.)

Вложения (опц.)
Кнопки:

“Сохранить”

“Отмена”
Ошибки:

нет прав

исполнитель не в проекте

дедлайн в прошлом (по политике: запретить или разрешить с предупреждением)

5.7. Экран 5 — Участники проекта (OWNER)

UI:

список участников: имя, username, роль

поиск

кнопка “Изменить роль” (dropdown)

(опц.) “Удалить из проекта” (если есть механизм)
Примечание:

В Telegram нельзя “удалить из чата” через Mini App; можно только ограничить доступ на уровне системы (деактивировать membership).

5.8. Экран 6 — Настройки (минимально)

UI:

Язык (RU, задел на EN)

Формат дедлайна (дата/дата+время)

Уведомления (вкл/выкл по событиям)

О системе (версия)
MVP можно упростить: экран может отсутствовать, настройки — дефолт.

6. Бизнес-правила и состояния
6.1. Статусы задач (MVP)

NEW — создана, не начата

IN_PROGRESS — в работе

DONE — выполнена

Переходы:

NEW → IN_PROGRESS → DONE

DONE → IN_PROGRESS (если OWNER переоткрыл) — опционально

6.2. Правила видимости

Пользователь видит задачу, если он участник проекта.

Исполнитель видит все задачи проекта, но управляет статусом только назначенных (по матрице).

6.3. История изменений (Audit)

Пишем событие при изменении:

title, description, assignee, deadline, status
Формат события:

кто, когда, что изменил, старое значение (опц.), новое значение (опц.)

7. Интеграция с Telegram
7.1. Компоненты

Telegram Bot: уведомления + entrypoint в Mini App.

Telegram Mini App (WebApp): SPA интерфейс.

Backend: валидирует initData, хранит данные.

7.2. Идентификация проекта (чата)

Цель: строго разделить данные разных чатов.

Рекомендуемая схема (надёжная для MVP):

Бот отправляет кнопку web_app в конкретный чат.

Вместе с кнопкой бот генерирует startapp/payload (например project_key=<uuid>), который:

однозначно соответствует chat_id (который бот знает из update)

хранится в backend в таблице Project

Mini App при старте получает start_param (если доступно) и отправляет его на backend.

Backend резолвит project_key → project_id, проверяет membership.

Если вы хотите “без стартовых параметров”: придётся опираться на chat_instance/chat_type из initData. Это возможно, но практическая надёжность зависит от сценариев Telegram. Для разработки с Codex проще и стабильнее держать явный project_key.

7.3. Уведомления ботом

События (MVP):

“Вам назначена задача …”

“Статус задачи изменён …”

“Дедлайн изменён …” (опц.)

Лимиты Telegram учитывать (не спамить, батчить при необходимости).

8. Архитектура и модули
8.1. Frontend (React)

Роутинг SPA: /loading, /projects, /tasks, /tasks/:id, /tasks/new, /settings, /members

API client (fetch/axios)

UI state: фильтры, пагинация

Telegram SDK wrapper:

init

theme params

back button

haptic feedback (опционально)

8.2. Backend (FastAPI)

Модули:

auth: валидация Telegram initData, выдача сессии

projects: проекты/участники/роли

tasks: CRUD задач, статусы

comments: CRUD комментариев

attachments: регистрация вложений (Telegram file_id / URL)

audit: журнал изменений

8.3. DB (PostgreSQL)

Схема ниже (раздел 10).

9. API контракт (HTTP/JSON)
9.1. Авторизация
POST /auth/telegram

Request

{
  "initData": "query_id=...&user=...&hash=...",
  "startParam": "project_key=..." 
}

Response 200

{
  "token": "jwt_access_token",
  "user": { "id": 1, "tg_id": 123, "name": "..." },
  "project": { "id": 10, "name": "Chat #1", "role": "OWNER" }
}

Ошибки

401 invalid initData

400 missing startParam (если обязателен)

403 user not in project

Примечание: можно хранить JWT в memory/localStorage; внутри Telegram чаще используют memory + повторный auth при перезапуске.

9.2. Проекты и участники
GET /projects

Возвращает проекты пользователя.

GET /projects/{projectId}/members
PATCH /projects/{projectId}/members/{userId}

Request

{ "role": "EXECUTOR" }
9.3. Задачи
GET /projects/{projectId}/tasks

Query:

tab=all|assigned|created

status=NEW|IN_PROGRESS|DONE (multi)

assigneeId

deadline=overdue|today|7d|none

sort=deadline|updated|created

page, pageSize

Response

{
  "items": [
    {
      "id": 501,
      "title": "Сверстать экран задач",
      "status": "IN_PROGRESS",
      "assignee": {"id": 2, "name": "..."},
      "author": {"id": 1, "name": "..."},
      "deadline": "2026-03-01T18:00:00Z",
      "updatedAt": "2026-02-23T10:10:00Z"
    }
  ],
  "page": 1,
  "pageSize": 20,
  "total": 57
}
POST /projects/{projectId}/tasks

Request

{
  "title": "…",
  "description": "…",
  "assigneeId": 2,
  "deadline": "2026-03-01T18:00:00Z",
  "attachments": [{"type":"TELEGRAM_FILE","tgFileId":"..."}]
}
GET /tasks/{taskId}

Включает:

task

attachments

comments (первые N)

audit log (первые N)

PATCH /tasks/{taskId}

Изменение полей (OWNER), запись в audit.

POST /tasks/{taskId}/status

Request

{ "status": "DONE" }
9.4. Комментарии
GET /tasks/{taskId}/comments?page=&pageSize=
POST /tasks/{taskId}/comments
{
  "text": "Готово, проверьте",
  "attachments": [{"type":"URL","url":"https://..."}]
}
9.5. Аудит
GET /tasks/{taskId}/audit?page=&pageSize=
10. Модель данных (PostgreSQL)
10.1. Таблицы
users

id PK

tg_id bigint unique

username text null

first_name text

last_name text null

photo_url text null

created_at timestamptz

last_login_at timestamptz

projects

id PK

tg_chat_id bigint null (если храните напрямую chat_id)

project_key uuid unique (рекомендуется для startParam)

title text

created_at timestamptz

project_members

project_id FK

user_id FK

role enum('OWNER','EXECUTOR','MEMBER','VIEWER')

is_active bool default true

joined_at timestamptz
PK: (project_id, user_id)

tasks

id PK

project_id FK

title varchar(120)

description text

status enum('NEW','IN_PROGRESS','DONE')

author_id FK users

assignee_id FK users

deadline_at timestamptz null

created_at timestamptz

updated_at timestamptz

Индексы:

(project_id, status)

(project_id, assignee_id)

(project_id, deadline_at)

(project_id, updated_at desc)

comments

id PK

task_id FK

author_id FK users

text text

created_at timestamptz

Индексы:

(task_id, created_at)

attachments

id PK

task_id FK null

comment_id FK null

type enum('TELEGRAM_FILE','URL')

tg_file_id text null

url text null

file_name text null

mime_type text null

created_at timestamptz

Ограничение:

CHECK: ровно одно из (task_id,comment_id) не null

task_audit_log

id PK

task_id FK

actor_id FK users

event_type enum('CREATE','UPDATE','STATUS_CHANGE','ASSIGNEE_CHANGE','DEADLINE_CHANGE','COMMENT_ADD','ATTACH_ADD')

field text null (например status, deadline_at)

old_value jsonb null

new_value jsonb null

created_at timestamptz

11. Нефункциональные требования
11.1. UX и интерфейс

Нативность под Telegram (theme params, минимализм, адаптив).

Основной сценарий — мобильный, но поддержать desktop.

Русский язык интерфейса (MVP).

11.2. Производительность

Открытие Mini App и загрузка списка задач — “несколько секунд максимум”.

Операции CRUD — без заметных задержек, с индикатором загрузки.

11.3. Безопасность

Строгая валидация initData по алгоритму Telegram (HMAC).

Все запросы по HTTPS.

Разделение данных по проекту (чату): пользователь не может получить задачи чужого проекта.

Токен бота хранится только на backend (ENV/secret).

Рекомендуется: rate limiting на чувствительные endpoints.

11.4. Логи и аудит

Серверные логи: request_id, user_id, project_id, latency.

Audit log — обязателен для изменений задач.

11.5. Надёжность

Миграции БД (Alembic).

Бэкапы Postgres (ежедневно).

Мониторинг ошибок (Sentry/аналог — опционально).

12. Развёртывание (MVP)
12.1. Компоненты

frontend (React build → static)

backend (FastAPI)

postgres

(опц.) nginx/reverse proxy

(опц.) redis для rate-limit/caching

12.2. Docker

Docker Compose для dev

CI/CD: деплой из GitHub (как описано в файле — Dockhost) 

Пояснительная записка отет

13. Тестирование и критерии приёмки
13.1. Минимальные тест-кейсы

Авторизация:

валидный initData → 200 + user created

невалидный initData → 401

Проектная изоляция:

user A в project 1 не видит tasks project 2 → 403/404

CRUD задач:

OWNER создаёт задачу → появляется в списке “созданные мной”

EXECUTOR видит назначенную → может поставить IN_PROGRESS/DONE

EXECUTOR не может менять assignee/deadline → 403

Комментарии:

участники проекта видят комментарии

viewer не может комментировать (если так настроено)

Audit:

изменение статуса создаёт запись в task_audit_log

13.2. Acceptance criteria (MVP)

В Telegram можно открыть Mini App из чата и увидеть задачи этого чата.

Заказчик создаёт задачу и назначает исполнителя из участников проекта.

Исполнитель меняет статусы и оставляет комментарии.

История изменений фиксируется и отображается в карточке задачи.

Фильтры по статусу работают, списки “назначенные/созданные” работают.

14. Backlog расширений (чтобы Codex мог развивать по промтам)

Статус “На проверке/Принята” и “Отклонена/Нужны правки”.

Упоминания и реакции в комментариях.

Связь комментариев с сообщениями Telegram (message_id deep-link).

Шаблоны задач.

Экспорт отчёта (PDF/CSV).

Роли на уровне задачи (наблюдатели).

SLA/напоминания по дедлайнам.